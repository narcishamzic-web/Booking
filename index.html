<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RomBooking â€“ Arbeidsplassen</title>
  <meta name="description" content="Rombooking med 5 Ã¸kter per dag, egne kalendere per rom, gjentakende bookinger og uke-/uketallsvisning. Kan deles i Teams." />
  <style>
    :root{
      --bg: #0b1020;
      --panel: #121931;
      --panel-2:#0f1530;
      --muted:#9aa3b2;
      --text:#eaf0ff;
      --accent:#6ea8ff;
      --danger:#ff6b6b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1020,#0a0f1e 40%,#090e1c);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(10,14,28,.95),rgba(10,14,28,.8));backdrop-filter: blur(6px);border-bottom:1px solid rgba(255,255,255,.06)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:22px;letter-spacing:.3px}

    .toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:14px}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{padding:10px 12px;border-radius:10px;background:var(--panel);border:1px solid rgba(255,255,255,.06);cursor:pointer;color:var(--text);transition:.2s;box-shadow:var(--shadow)}
    .tab:hover{transform:translateY(-1px)}
    .tab.active{background:linear-gradient(180deg,#12224a,#101a38);border-color:#2b4c89}

    .spacer{flex:1}
    .btn{appearance:none;border:none;border-radius:10px;padding:10px 12px;background:var(--panel);color:var(--text);cursor:pointer;border:1px solid rgba(255,255,255,.08);transition:.2s;box-shadow:var(--shadow)}
    .btn:hover{transform:translateY(-1px)}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn.danger{background:linear-gradient(180deg,#7a2230,#5e1a25);border-color:#a33}
    .btn.toggle[aria-pressed="true"]{outline:2px solid #2b64c9}

    .calendar{margin:18px auto;max-width:1200px;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.06);box-shadow:var(--shadow)}
    .cal-head{display:grid;grid-template-columns:160px repeat(7,1fr);background:var(--panel)}
    .cal-row{display:grid;grid-template-columns:160px repeat(7,1fr)}
    .cell,.headcell{border:1px solid rgba(255,255,255,.06);padding:10px;min-height:72px}
    .headcell{background:linear-gradient(180deg,#151d3a,#101731);color:#cfe1ff;text-align:center;font-size:13px}
    .slotlabel{display:flex;gap:8px;align-items:center;height:100%;background:linear-gradient(180deg,#0d152f,#0b1226)}
    .slotlabel strong{font-size:14px}
    .cell{background:linear-gradient(180deg,#0d142e,#0b1124)}
    .cell[data-booked="true"]{background:linear-gradient(180deg,#13223f,#101a34)}
    .booking{display:flex;flex-direction:column;gap:6px;padding:8px;border-radius:10px;background:rgba(110,168,255,.12);border:1px solid rgba(110,168,255,.35)}
    .booking .title{font-weight:600}
    .booking .meta{font-size:12px;color:var(--muted)}

    .legend{display:flex;gap:14px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-top:8px}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;background:#6ea8ff;border:1px solid rgba(110,168,255,.7)}

    .nav{display:flex;gap:8px;align-items:center}
    .weektitle{font-weight:700}
    .small{font-size:12px;color:var(--muted)}

    dialog{border:1px solid rgba(255,255,255,.1);border-radius:16px;background:linear-gradient(180deg,#0f1732,#0d1429);color:var(--text);padding:0;box-shadow:var(--shadow)}
    .modal-head{padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;align-items:center}
    .modal-body{padding:16px 18px;display:flex;flex-direction:column;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:13px;color:var(--muted)}
    input,select{background:#101730;border:1px solid rgba(255,255,255,.12);border-radius:10px;color:var(--text);padding:10px}
    .modal-actions{display:flex;gap:10px;justify-content:flex-end;padding:14px 18px;border-top:1px solid rgba(255,255,255,.08)}

    .foot{color:var(--muted);font-size:12px;text-align:center;margin:20px 0}
    .pill{display:inline-block;padding:4px 8px;border:1px solid rgba(255,255,255,.14);border-radius:999px;background:rgba(255,255,255,.04)}
    .roomtitle{font-weight:600}

    @media (max-width: 900px){
      .cal-head,.cal-row{grid-template-columns:120px repeat(7,1fr)}
      .cell{min-height:84px}
    }
    @media (max-width: 720px){
      .cal-head,.cal-row{grid-template-columns:90px repeat(7,1fr)}
      .headcell{padding:8px;font-size:11px}
      .slotlabel strong{font-size:13px}
    }
    @media (max-width: 580px){
      .tabs{overflow:auto;white-space:nowrap}
      .calendar{border:none;border-radius:0}
      .wrap{padding:12px}
      .cal-head,.cal-row{grid-template-columns:80px repeat(7,1fr)}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>RomBooking</h1>

    <div class="toolbar">
      <div class="tabs" id="roomTabs"></div>
      <div class="spacer"></div>
      <div class="nav">
        <button class="btn" id="prevWeekBtn" title="Forrige uke">âŸµ</button>
        <div>
          <div class="weektitle" id="weekTitle">Uke X</div>
          <div class="small" id="weekRange">Mandag â€“ SÃ¸ndag</div>
        </div>
        <button class="btn" id="nextWeekBtn" title="Neste uke">âŸ¶</button>
      </div>
      <input type="date" id="jumpDate" class="btn" />
      <button class="btn" id="exportBtn" title="Eksporter rommets kalender til .ics">Eksporter .ics</button>
      <button class="btn" id="clearBtn" title="TÃ¸m alle bookinger for valgt rom">TÃ¸m rom</button>
      <button class="btn toggle" id="followBtn" aria-pressed="true" title="FÃ¸lg nÃ¥-uke automatisk">FÃ¸lg nÃ¥-uke</button>
    </div>
    <div class="legend">
      <span><i class="dot"></i> Booket</span>
      <span class="pill">Klikk en rute for Ã¥ booke/frigi</span>
    </div>
  </div>
</header>

<div class="calendar" id="calendar"></div>

<dialog id="bookingDialog">
  <div class="modal-head">
    <div>
      <div class="roomtitle" id="modalRoom">Rom</div>
      <div class="small" id="modalWhen">Dato â€¢ Ã˜kt</div>
    </div>
    <button class="btn" id="closeDialog">Lukk</button>
  </div>
  <form class="modal-body" id="bookingForm">
    <div class="field">
      <label for="teacher">LÃ¦rer (navn)</label>
      <input id="teacher" name="teacher" required placeholder="F.eks. Kari Nordmann" />
    </div>
    <div class="field">
      <label for="title">Aktivitet/klasse (valgfritt)</label>
      <input id="title" name="title" placeholder="F.eks. 9B norsk, mÃ¸te, prÃ¸ve ..." />
    </div>
    <div class="field">
      <label for="repeat">Gjentakende</label>
      <select id="repeat" name="repeat">
        <option value="none">Ingen</option>
        <option value="weekly">Hver uke</option>
        <option value="biweekly">Annenhver uke</option>
      </select>
    </div>
    <div class="field" id="repeatUntilWrap" style="display:none">
      <label for="repeatUntil">Gjenta til og med dato (maks 28.06.2026)</label>
      <input type="date" id="repeatUntil" name="repeatUntil" />
    </div>
  </form>
  <div class="modal-actions">
    <button class="btn danger" id="deleteBtn" type="button">Slett booking</button>
    <div class="spacer"></div>
    <button class="btn" id="saveBtn" type="button">Lagre</button>
  </div>
</dialog>

<div class="foot">
  Laget for deling i Teams. <span class="small">Versjon 1.0 Â· Lokal/Firebase lagring Â· Tidssone: <span id="tz"></span></span>
</div>

<!-- Firebase (CDN compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script>
(() => {
  // --- Konfig ---
  const ROOMS = [
    "MÃ¸terommet","Grupperom 222","Auditoriet","Grupperom 104","Grupperom 116","Leserommet","Gymsal","Musikkrommet"
  ];
  const NUM_SESSIONS = 5; // 1.â€“5. Ã¸kt
  const MAX_DATE = new Date("2026-06-28T23:59:59");
  const STORAGE_KEY = "rombooking.v1"; // lokal fallback
  const FOLLOW_KEY = "rombooking.followWeek";

  // ðŸ”Œ Felles lagring via Firebase â€“ din konfig:
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyDQTUj59sCUn9Koh8MTs8MZf0TdlnfE8SY",
    authDomain: "booking-f55c3.firebaseapp.com",
    projectId: "booking-f55c3",
    appId: "1:90445185171:web:7cc06467ca6d78e704f026"
  };

  // TVING lokal modus for Ã¥ fÃ¥ alt opp i drift igjen. Sett til false nÃ¥r vi vil teste Firebase pÃ¥ nytt.
  const FORCE_LOCAL = true;
  let USE_FIREBASE = !FORCE_LOCAL && !!FIREBASE_CONFIG.apiKey && !String(FIREBASE_CONFIG.apiKey).startsWith('YOUR_');
  let db=null; let unsubscribe=null;

  // --- Hjelpefunksjoner ---
  const clampToMax = (d)=> d>MAX_DATE ? new Date(MAX_DATE) : d;
  const pad = (n)=> n.toString().padStart(2,'0');
  const toISODate = (d)=> `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const fromISODate = (s)=> { const [y,m,dd] = s.split('-').map(Number); return new Date(y, m-1, dd); };

  function getISOWeek(d){
    const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = (date.getUTCDay() + 6) % 7; // 0=mandag
    date.setUTCDate(date.getUTCDate() - dayNum + 3);
    const firstThursday = new Date(Date.UTC(date.getUTCFullYear(),0,4));
    const diff = (date - firstThursday)/86400000;
    return 1 + Math.floor(diff/7);
  }
  function startOfISOWeek(d){
    const date = new Date(d);
    const day = (date.getDay() + 6) % 7; // 0=mandag
    date.setDate(date.getDate() - day);
    date.setHours(0,0,0,0);
    return date;
  }
  const weekdayNames = ["Man","Tir","Ons","Tor","Fre","LÃ¸r","SÃ¸n"];

  // --- Lokal lagring fallback ---
  function loadState(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch { return {}; } }
  function saveState(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }

  let state = loadState();
  ROOMS.forEach(r=>{ if(!state[r]) state[r] = {}; });

  // --- UI refs ---
  const roomTabs = document.getElementById('roomTabs');
  const calendar = document.getElementById('calendar');
  const weekTitle = document.getElementById('weekTitle');
  const weekRange = document.getElementById('weekRange');
  const prevWeekBtn = document.getElementById('prevWeekBtn');
  const nextWeekBtn = document.getElementById('nextWeekBtn');
  const jumpDate = document.getElementById('jumpDate');
  const exportBtn = document.getElementById('exportBtn');
  const clearBtn = document.getElementById('clearBtn');
  const followBtn = document.getElementById('followBtn');
  const tz = document.getElementById('tz');

  const bookingDialog = document.getElementById('bookingDialog');
  const modalRoom = document.getElementById('modalRoom');
  const modalWhen = document.getElementById('modalWhen');
  const teacherInput = document.getElementById('teacher');
  const titleInput = document.getElementById('title');
  const repeatSel = document.getElementById('repeat');
  const repeatUntilWrap = document.getElementById('repeatUntilWrap');
  const repeatUntil = document.getElementById('repeatUntil');
  const saveBtn = document.getElementById('saveBtn');
  const deleteBtn = document.getElementById('deleteBtn');
  const closeDialogBtn = document.getElementById('closeDialog');

  tz.textContent = Intl.DateTimeFormat().resolvedOptions().timeZone;

  // --- Firebase init ---
  if(USE_FIREBASE && window.firebase){
    try{
      firebase.initializeApp(FIREBASE_CONFIG);
      db = firebase.firestore();
      firebase.auth().signInAnonymously().catch(e=>{ console.error('Auth feilet', e); USE_FIREBASE=false; });
    } catch(e){ console.error('Init Firebase feilet', e); USE_FIREBASE=false; }
  } else {
    USE_FIREBASE = false; // sikker fallback
  }

  // --- Tabs ---
  let currentRoom = ROOMS[0];
  function renderTabs(){
    roomTabs.innerHTML = '';
    ROOMS.forEach(r => {
      const b = document.createElement('button');
      b.className = 'tab' + (r===currentRoom? ' active':'');
      b.textContent = r;
      b.onclick = ()=>{ currentRoom = r; renderTabs(); renderWeek(); subscribeToWeek(); };
      roomTabs.appendChild(b);
    });
  }

  // --- Uke + auto-fÃ¸lg ---
  let currentMonday = startOfISOWeek(new Date());
  let followWeek = (()=>{ try { const v = localStorage.getItem(FOLLOW_KEY); return v==null ? true : v==='true'; } catch { return true; } })();
  function setFollowWeek(v){ followWeek=v; localStorage.setItem(FOLLOW_KEY,String(v)); renderFollowBtn(); }
  function renderFollowBtn(){ followBtn.setAttribute('aria-pressed', String(followWeek)); followBtn.textContent = followWeek ? 'FÃ¸lg nÃ¥-uke' : 'LÃ¥s uke'; }
  function jumpToCurrentWeek(){ currentMonday = startOfISOWeek(new Date()); renderWeek(); subscribeToWeek(); }
  function tickFollow(){ if(!followWeek) return; const nowMon = startOfISOWeek(new Date()); if(toISODate(nowMon)!==toISODate(currentMonday)){ currentMonday=nowMon; renderWeek(); subscribeToWeek(); } }

  function renderWeek(){
    const week = getISOWeek(currentMonday);
    weekTitle.textContent = `Uke ${week}`;
    const end = new Date(currentMonday); end.setDate(end.getDate()+6);
    weekRange.textContent = `${currentMonday.toLocaleDateString('no-NO',{day:'2-digit',month:'2-digit'})} â€“ ${end.toLocaleDateString('no-NO',{day:'2-digit',month:'2-digit'})}`;

    const head = document.createElement('div'); head.className='cal-head';
    const first = document.createElement('div'); first.className='headcell'; first.textContent='Ã˜kt / Dag'; head.appendChild(first);
    for(let i=0;i<7;i++){
      const d = new Date(currentMonday); d.setDate(d.getDate()+i);
      const hc = document.createElement('div'); hc.className='headcell';
      const dayName = weekdayNames[i];
      hc.innerHTML = `<div><strong>${dayName}</strong></div><div class="small">${d.toLocaleDateString('no-NO',{day:'2-digit',month:'2-digit'})}</div>`;
      head.appendChild(hc);
    }

    const rows = [];
    for(let s=1; s<=NUM_SESSIONS; s++){
      const row = document.createElement('div'); row.className='cal-row';
      const label = document.createElement('div'); label.className='cell slotlabel'; label.innerHTML = `<strong>${s}. Ã¸kt</strong>`; row.appendChild(label);
      for(let i=0;i<7;i++){
        const d = new Date(currentMonday); d.setDate(d.getDate()+i);
        const cell = document.createElement('div'); cell.className='cell';
        cell.dataset.date = toISODate(d); cell.dataset.session = s;
        const b = getBooking(currentRoom, cell.dataset.date, s);
        updateCell(cell, b);
        cell.onclick = ()=> openBooking(cell.dataset.date, s);
        row.appendChild(cell);
      }
      rows.push(row);
    }

    calendar.innerHTML='';
    calendar.appendChild(head);
    rows.forEach(r=>calendar.appendChild(r));

    jumpDate.value = toISODate(currentMonday);
  }

  prevWeekBtn.onclick = ()=>{ setFollowWeek(false); currentMonday.setDate(currentMonday.getDate()-7); renderWeek(); subscribeToWeek(); };
  nextWeekBtn.onclick = ()=>{ setFollowWeek(false); currentMonday.setDate(currentMonday.getDate()+7); renderWeek(); subscribeToWeek(); };
  jumpDate.onchange = (e)=>{ setFollowWeek(false); currentMonday = startOfISOWeek(fromISODate(e.target.value)); renderWeek(); subscribeToWeek(); };
  followBtn.onclick = ()=>{ if(followWeek){ setFollowWeek(false); } else { setFollowWeek(true); jumpToCurrentWeek(); } };

  // --- Bookinger ---
  function getBooking(room, dateStr, session){ return state[room]?.[dateStr]?.[session] || null; }
  function setBookingLocal(room, dateStr, session, booking){ if(!state[room]) state[room]={}; if(!state[room][dateStr]) state[room][dateStr]={}; if(booking) state[room][dateStr][session]=booking; else delete state[room][dateStr][session]; saveState(state); }

  async function setBooking(room, dateStr, session, booking){
    if(USE_FIREBASE && db){
      const id = `${room}|${dateStr}|${session}`;
      const ref = db.collection('bookings').doc(id);
      if(booking){ await ref.set({ room, date: dateStr, session: Number(session), teacher: booking.teacher||'', title: booking.title||'', updatedAt: Date.now() }, { merge:true }); }
      else { await ref.delete(); }
    } else {
      setBookingLocal(room, dateStr, session, booking);
    }
  }

  function updateCell(cell, booking){
    cell.innerHTML = '';
    if(booking){
      cell.dataset.booked = 'true';
      const el = document.createElement('div'); el.className='booking';
      el.innerHTML = `<div class="title">${escapeHtml(booking.title || 'Booket')}</div><div class="meta">${escapeHtml(booking.teacher || '')}</div>`;
      cell.appendChild(el);
    } else { cell.dataset.booked='false'; }
  }

  function subscribeToWeek(){
    if(unsubscribe){ unsubscribe(); unsubscribe=null; }
    if(!(USE_FIREBASE && db)) return;
    // Midlertidig/robust: hent alt for valgt rom og filtrer datoer lokalt
    // Dette krever IKKE kompositt-indeks i Firestore.
    const start = toISODate(currentMonday);
    const endD = new Date(currentMonday); endD.setDate(endD.getDate()+6);
    const end = toISODate(endD);

    unsubscribe = db.collection('bookings')
      .where('room','==', currentRoom)
      .onSnapshot(snap => {
        const weekData = {};
        snap.forEach(doc => {
          const b = doc.data();
          if(b.date >= start && b.date <= end){
            if(!weekData[b.date]) weekData[b.date] = {};
            weekData[b.date][b.session] = { teacher: b.teacher, title: b.title };
          }
        });
        state[currentRoom] = weekData;
        renderWeek();
      }, err => console.error('Firestore listener error', err));
  }
    if(!(USE_FIREBASE && db)) return;
    const start = toISODate(currentMonday); const endD = new Date(currentMonday); endD.setDate(endD.getDate()+6); const end = toISODate(endD);
    unsubscribe = db.collection('bookings')
      .where('room','==', currentRoom)
      .where('date','>=', start)
      .where('date','<=', end)
      .onSnapshot(snap => {
        // Rensk uke for valgt rom, fyll med snapshot
        state[currentRoom] = {};
        snap.forEach(doc => { const b = doc.data(); if(!state[currentRoom][b.date]) state[currentRoom][b.date]={}; state[currentRoom][b.date][b.session] = { teacher:b.teacher, title:b.title }; });
        renderWeek();
      }, err => console.error('Firestore listener error', err));
  }

  // --- Modal ---
  let active=null; // {room,dateStr,session}
  function openBooking(dateStr, session){
    const date = fromISODate(dateStr); if(date>MAX_DATE){ alert('Kan ikke booke etter 28.06.2026'); return; }
    active = {room: currentRoom, dateStr, session};
    modalRoom.textContent = currentRoom;
    const week = getISOWeek(date); const dayName = weekdayNames[(date.getDay()+6)%7];
    modalWhen.textContent = `${dayName} ${date.toLocaleDateString('no-NO')} â€¢ ${session}. Ã¸kt â€¢ Uke ${week}`;

    const existing = getBooking(currentRoom, dateStr, session);
    teacherInput.value = existing?.teacher || '';
    titleInput.value = existing?.title || '';
    repeatSel.value = 'none'; repeatUntilWrap.style.display='none'; repeatUntil.value='';

    deleteBtn.style.display = existing ? 'inline-flex' : 'none';

    bookingDialog.showModal();
  }
  function closeBooking(){ bookingDialog.close(); }
  closeDialogBtn.onclick = closeBooking;

  repeatSel.onchange = ()=>{ repeatUntilWrap.style.display = (repeatSel.value==='none') ? 'none':'flex'; };

  saveBtn.onclick = async ()=>{
    if(!active) return;
    const teacher = teacherInput.value.trim(); if(!teacher){ alert('Skriv inn lÃ¦rer'); return; }
    const title = titleInput.value.trim(); const baseDate = fromISODate(active.dateStr);
    const repeat = repeatSel.value; let until = repeatUntil.value ? clampToMax(new Date(repeatUntil.value)) : MAX_DATE;

    const booking = { teacher, title };
    const stepDays = repeat==='weekly' ? 7 : (repeat==='biweekly' ? 14 : 0);

    if(stepDays===0){ await setBooking(active.room, active.dateStr, active.session, booking); }
    else { let d = new Date(baseDate); while(d<=until){ const ds = toISODate(d); await setBooking(active.room, ds, active.session, booking); d.setDate(d.getDate()+stepDays); } }

    renderWeek(); closeBooking();
  };

  deleteBtn.onclick = async ()=>{
    if(!active) return; const existing = getBooking(active.room, active.dateStr, active.session); if(!existing){ closeBooking(); return; }
    const applySeries = confirm('Slette kun denne Ã¸kten? (OK)\n\nVelg Avbryt for Ã¥ slette serien (samme ukedag/Ã¸kt framover).');
    if(applySeries){ await setBooking(active.room, active.dateStr, active.session, null); }
    else { const baseDate = fromISODate(active.dateStr); let d = new Date(baseDate); while(d<=MAX_DATE){ const ds = toISODate(d); await setBooking(active.room, ds, active.session, null); d.setDate(d.getDate()+7); } }
    renderWeek(); closeBooking();
  };

  // --- Eksport til .ics ---
  exportBtn.onclick = ()=>{
    const ics = buildICSForRoom(currentRoom);
    const blob = new Blob([ics], {type:'text/calendar'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${currentRoom.replace(/\s+/g,'_')}.ics`; a.click();
  };

  // --- TÃ¸m rom ---
  clearBtn.onclick = async ()=>{
    if(!confirm(`TÃ¸m ALLE bookinger for Â«${currentRoom}Â»?`)) return;
    if(USE_FIREBASE && db){
      const snap = await db.collection('bookings').where('room','==', currentRoom).get();
      const batch = db.batch(); snap.forEach(doc=> batch.delete(doc.ref)); await batch.commit();
    } else { state[currentRoom] = {}; saveState(state); }
    renderWeek();
  };

  function buildICSForRoom(room){
    const lines = ['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//RomBooking//NO','CALSCALE:GREGORIAN'];
    const data = state[room] || {};
    for(const dateStr of Object.keys(data)){
      for(const session of Object.keys(data[dateStr])){
        const b = data[dateStr][session]; if(!b) continue; const uid = `${room}-${dateStr}-s${session}-${Math.random().toString(36).slice(2)}@rombooking`;
        const dt = fromISODate(dateStr);
        const times = [['08:15','09:45'],['10:00','11:30'],['11:45','13:15'],['13:30','15:00'],['15:15','16:45']];
        const [start,end] = times[Number(session)-1];
        const dtStart = new Date(dt); const [sh,sm]=start.split(':').map(Number); dtStart.setHours(sh,sm,0,0);
        const dtEnd   = new Date(dt); const [eh,em]=end.split(':').map(Number); dtEnd.setHours(eh,em,0,0);
        const fmtICS = (d)=> d.toISOString().replace(/[-:]/g,'').replace(/\..+/, 'Z');
        const summary = (b.title? `${b.title} â€“ `:'') + `${room}`;
        lines.push('BEGIN:VEVENT','UID:'+uid,'DTSTAMP:'+fmtICS(new Date()),'DTSTART:'+fmtICS(dtStart),'DTEND:'+fmtICS(dtEnd),'SUMMARY:'+escapeICS(summary),'DESCRIPTION:'+escapeICS(`LÃ¦rer: ${b.teacher || ''}`),'END:VEVENT');
      }
    }
    lines.push('END:VCALENDAR'); return lines.join('\r\n');
  }

  // --- Init ---
  (function init(){ renderTabs(); renderFollowBtn(); renderWeek(); subscribeToWeek(); })();
  setInterval(tickFollow, 60*1000); document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) tickFollow(); });

  // --- Utils ---
  function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'}[m])); }
  function escapeICS(text){ return String(text||'').replace(/\\/g,'\\\\').replace(/\n/g,'\\n').replace(/,/g,'\\,').replace(/;/g,'\\;'); }
})();
</script>
</body>
</html>
